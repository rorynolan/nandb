<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculating brightness with single images • nandb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculating brightness with single images">
<meta property="og:description" content="nandb">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nandb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/batch-mode.html">Batch mode</a>
    </li>
    <li>
      <a href="../articles/brightness-timeseries.html">Brightness timeseries</a>
    </li>
    <li>
      <a href="../articles/single-images.html">Calculating brightness with single images</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rorynolan/nandb/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="single-images_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calculating brightness with single images</h1>
                        <h4 class="author">Rory Nolan</h4>
            
            <h4 class="date">2021-05-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rorynolan/nandb/blob/master/vignettes/single-images.Rmd"><code>vignettes/single-images.Rmd</code></a></small>
      <div class="hidden name"><code>single-images.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we will look at calculating the brightness of single images interactively in an R session.</p>
<p>First let’s load <code>nandb</code> and <code>ijtiff</code>, which is for reading TIFF files:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">nandb</span>, <span class="va">ijtiff</span><span class="op">)</span></code></pre></div>
<div id="ordinary-brightness" class="section level2">
<h2 class="hasAnchor">
<a href="#ordinary-brightness" class="anchor"></a>Ordinary brightness</h2>
<p>The package contains a sample image series which can be found at<br><code><a href="https://rdrr.io/r/base/system.file.html">system.file("extdata", "two_ch.tif", package = "nandb")</a></code>. It’s 2 channels each with 100 frames. Diffusing fluorescent particles are imaged. Protein A is labelled with a red dye and red photons are collected in channel 1. Protein B is labelled in green and green photons are collected in channel 2.</p>
<p>The image can be read into R with the <code>read_tif()</code> command provided by the <code>ijtiff</code> package. We’ll assign it to a variable called <code>my_img</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"two_ch.tif"</span>, package <span class="op">=</span> <span class="st">"nandb"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "/Users/runner/work/_temp/Library/nandb/extdata/two_ch.tif"</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_img</span> <span class="op">&lt;-</span> <span class="fu">read_tif</span><span class="op">(</span><span class="va">path</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; Reading two_ch.tif: an 8-bit, 30x28 pixel image of unsigned
#&gt; integer type. Reading 2 channels and 100 frames . . .</code></pre>
<pre><code>#&gt;  Done.</code></pre>
<p><code>my_img</code> is now a 4-dimensional array. Slots 1 and 2 hold the <code>y</code> and <code>x</code> pixel positions, slot 3 indexes the channel and slot 4 indexes the frame.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">my_img</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1]  30  28   2 100</code></pre>
<div id="the-need-for-detrending" class="section level3">
<h3 class="hasAnchor">
<a href="#the-need-for-detrending" class="anchor"></a>The need for detrending</h3>
<p>Plotting the mean intensities of the frames in the two channels, we can see that the second channel has more obvious bleaching.</p>
<pre><code>#&gt; Warning: Removed 1 rows containing non-finite values (stat_smooth).</code></pre>
<pre><code>#&gt; Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<p><img src="single-images_files/figure-html/plot-mean-profile-1.png" width="672"></p>
<p>The presence of bleaching in this image series tells us that we should employ a detrending routine as part of our calculations. Often it’s not obvious whether or not detrending is required. <code>nandb</code> includes <em>Robin Hood</em> detrending which won’t interfere too much with images that don’t need detrending, whilst effictively detrending images that do need it. Hence, it’s pretty safe to have this detrending option turned on in general, and you should only leave it off if you’re sure it’s not needed. To turn on detrending, use <code>detrend = TRUE</code> in the <code><a href="../reference/brightness.html">brightness()</a></code> functions.</p>
</div>
<div id="thresholding" class="section level3">
<h3 class="hasAnchor">
<a href="#thresholding" class="anchor"></a>Thresholding</h3>
<p>You can see here that this is an image of part of a cell, with the edge of the cell across the top left and hence the top left corner of the image is not cell, just background. It’s important to <em>threshold</em> away this background part: the detrending routine assumes that all parts of the image are part of the region of interest (the cell) and later, when you calculate summary statistics like mean/median brightness, you also want to background regions to be excluded. Hence, you need to set the background parts to <code>NA</code> before detrending and brightness calculations. <code>nandb</code> has all of the thresholding functionality of the <em>ImageJ Auto Threshold</em> plugin. You can read more about this at <a href="https://imagej.net/Auto_Threshold" class="uri">https://imagej.net/Auto_Threshold</a>. My favourite method is <em>Huang</em>. Let’s look at both of these channels with <em>Huang</em> thresholding.</p>
<pre><code>#&gt; Using basic display functionality.
#&gt;   * For better display functionality, install the EBImage package.
#&gt;   * To install `EBImage`:
#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.
#&gt;     - Then run `BiocManager::install("EBImage")`.
#&gt; Using basic display functionality.
#&gt;   * For better display functionality, install the EBImage package.
#&gt;   * To install `EBImage`:
#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.
#&gt;     - Then run `BiocManager::install("EBImage")`.</code></pre>
<p><img src="single-images_files/figure-html/display-thresholded-mean-1.png" width="672"></p>
<p>That seems to have worked: the background region in the top left is now greyed out, indicating that it has been set to <code>NA</code>. <em>Huang</em> thresholding can be slow, so if you want something similar but faster, try <em>Triangle</em>. Always check that your thresholding <em>looks right</em> afterwards.</p>
<p>Note that if all of the image is of interest, detrending is not necessary and should not be done.</p>
</div>
<div id="calculation-including-thresholding-and-detrending" class="section level3">
<h3 class="hasAnchor">
<a href="#calculation-including-thresholding-and-detrending" class="anchor"></a>Calculation including thresholding and detrending</h3>
<p>To calculate the brightness of this image with <em>Huang</em> thresholding and <em>Robin Hood</em> detrending, with the <em>epsilon</em> definition of brightness, run</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_brightness_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness.html">brightness</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, 
                                thresh <span class="op">=</span> <span class="st">"Huang"</span>, detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div id="timeseries-calculation" class="section level4">
<h4 class="hasAnchor">
<a href="#timeseries-calculation" class="anchor"></a>Timeseries calculation</h4>
<p>To calculate a brightness timeseries with 50 frames per set, run</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_brightness_ts_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness_timeseries.html">brightness_timeseries</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, 
                                              frames_per_set <span class="op">=</span> <span class="fl">50</span>,
                                              thresh <span class="op">=</span> <span class="st">"Huang"</span>, detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>To calculate an overlapped brightness timeseries with 50 frames per set, run</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_brightness_ts_img_overlapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness_timeseries.html">brightness_timeseries</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, 
                                                         frames_per_set <span class="op">=</span> <span class="fl">50</span>,
                                                         overlap <span class="op">=</span> <span class="cn">TRUE</span>,
                                                         thresh <span class="op">=</span> <span class="st">"Huang"</span>, 
                                                         detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="saving-images" class="section level3">
<h3 class="hasAnchor">
<a href="#saving-images" class="anchor"></a>Saving Images</h3>
<p>We can save the brightness images with <code>write_tif()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_img</span>, <span class="st">"desired/path/of/my-brightness-img"</span><span class="op">)</span>
<span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_ts_img</span>, <span class="st">"desired/path/of/my-brightness-ts-img"</span><span class="op">)</span>
<span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_ts_img_overlapped</span>, 
          <span class="st">"desired/path/of/my-brightness-ts-img-overlapped"</span><span class="op">)</span></code></pre></div>
</div>
<div id="studying-the-distribution-of-brightnesses" class="section level3">
<h3 class="hasAnchor">
<a href="#studying-the-distribution-of-brightnesses" class="anchor"></a>Studying the Distribution of Brightnesses</h3>
<p>We can take a look at the distribution of brightnesses in channel 1 of the brightness image:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">my_brightness_img</span><span class="op">[</span>, , <span class="fl">1</span>, <span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">db</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"brightness"</span>, y <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Channel 1 brightness distribution"</span><span class="op">)</span></code></pre></div>
<p><img src="single-images_files/figure-html/brightness%20density-1.png" width="672"></p>
<p>We can compare that to the distribution of brightnesses from immobile particles:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immobile_brightnesses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">50</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="fl">6</span>, <span class="fl">50</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">6</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="op">{</span><span class="fu">matrixStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowVars.html">rowVars</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">}</span>
<span class="va">di</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">immobile_brightnesses</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu">mutate</span><span class="op">(</span><span class="va">db</span>, mobility <span class="op">=</span> <span class="st">"mobile"</span><span class="op">)</span>, <span class="fu">mutate</span><span class="op">(</span><span class="va">di</span>, mobility <span class="op">=</span> <span class="st">"immobile"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>mobility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">mobility</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour <span class="op">=</span> <span class="va">mobility</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"brightness"</span>, y <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Channel 1 brightness distribution compared to immobile entities"</span><span class="op">)</span></code></pre></div>
<p><img src="single-images_files/figure-html/immobile%20plot-1.png" width="672"></p>
<p>Note that to create plots like these, you’ll need knowledge of the <code>ggplot2</code> package.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rory Nolan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
