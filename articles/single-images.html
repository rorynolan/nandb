<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculating brightness with single images • nandb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculating brightness with single images">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nandb</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/batch-mode.html">Batch mode</a>
    </li>
    <li>
      <a href="../articles/brightness-timeseries.html">Brightness timeseries</a>
    </li>
    <li>
      <a href="../articles/single-images.html">Calculating brightness with single images</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rorynolan/nandb/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calculating brightness with single images</h1>
                        <h4 data-toc-skip class="author">Rory Nolan</h4>
            
            <h4 data-toc-skip class="date">2025-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rorynolan/nandb/blob/master/vignettes/single-images.Rmd" class="external-link"><code>vignettes/single-images.Rmd</code></a></small>
      <div class="hidden name"><code>single-images.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we will look at calculating the brightness of
single images interactively in an R session.</p>
<p>First let’s load <code>nandb</code> and <code>ijtiff</code>, which is
for reading TIFF files:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html" class="external-link">p_load</a></span><span class="op">(</span><span class="va">nandb</span>, <span class="va">ijtiff</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="ordinary-brightness">Ordinary brightness<a class="anchor" aria-label="anchor" href="#ordinary-brightness"></a>
</h2>
<p>The package contains a sample image series which can be found
at<br><code>system.file("extdata", "two_ch.tif", package = "nandb")</code>.
It’s 2 channels each with 100 frames. Diffusing fluorescent particles
are imaged. Protein A is labelled with a red dye and red photons are
collected in channel 1. Protein B is labelled in green and green photons
are collected in channel 2.</p>
<p>The image can be read into R with the <code>read_tif()</code> command
provided by the <code>ijtiff</code> package. We’ll assign it to a
variable called <code>my_img</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"two_ch.tif"</span>, package <span class="op">=</span> <span class="st">"nandb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "/Users/runner/work/_temp/Library/nandb/extdata/two_ch.tif"</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_img</span> <span class="op">&lt;-</span> <span class="fu">read_tif</span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Reading two_ch.tif: an 8-bit, 30x28 pixel image of unsigned</span></span>
<span><span class="co">#&gt; integer type. Reading 2 channels and 100 frames . . .</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Done.</span></span></code></pre>
<p><code>my_img</code> is now a 4-dimensional array. Slots 1 and 2 hold
the <code>y</code> and <code>x</code> pixel positions, slot 3 indexes
the channel and slot 4 indexes the frame.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">my_img</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1]  30  28   2 100</span></span></code></pre>
<div class="section level3">
<h3 id="the-need-for-detrending">The need for detrending<a class="anchor" aria-label="anchor" href="#the-need-for-detrending"></a>
</h3>
<p>Plotting the mean intensities of the frames in the two channels, we
can see that the second channel has more obvious bleaching.</p>
<pre><code><span><span class="co">#&gt; Warning: Removed 1 row containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_smooth()`).</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre>
<p><img src="single-images_files/figure-html/plot-mean-profile-1.png" width="672"></p>
<p>The presence of bleaching in this image series tells us that we
should employ a detrending routine as part of our calculations. Often
it’s not obvious whether or not detrending is required.
<code>nandb</code> includes <em>Robin Hood</em> detrending which won’t
interfere too much with images that don’t need detrending, whilst
effictively detrending images that do need it. Hence, it’s pretty safe
to have this detrending option turned on in general, and you should only
leave it off if you’re sure it’s not needed. To turn on detrending, use
<code>detrend = TRUE</code> in the <code><a href="../reference/brightness.html">brightness()</a></code>
functions.</p>
</div>
<div class="section level3">
<h3 id="thresholding">Thresholding<a class="anchor" aria-label="anchor" href="#thresholding"></a>
</h3>
<p>You can see here that this is an image of part of a cell, with the
edge of the cell across the top left and hence the top left corner of
the image is not cell, just background. It’s important to
<em>threshold</em> away this background part: the detrending routine
assumes that all parts of the image are part of the region of interest
(the cell) and later, when you calculate summary statistics like
mean/median brightness, you also want to background regions to be
excluded. Hence, you need to set the background parts to <code>NA</code>
before detrending and brightness calculations. <code>nandb</code> has
all of the thresholding functionality of the <em>ImageJ Auto
Threshold</em> plugin. You can read more about this at <a href="https://imagej.net/plugins/auto-threshold" class="external-link uri">https://imagej.net/plugins/auto-threshold</a>. My favourite
method is <em>Huang</em>. Let’s look at both of these channels with
<em>Huang</em> thresholding.</p>
<pre><code><span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span>
<span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span></code></pre>
<p><img src="single-images_files/figure-html/display-thresholded-mean-1.png" width="672"></p>
<p>That seems to have worked: the background region in the top left is
now greyed out, indicating that it has been set to <code>NA</code>.
<em>Huang</em> thresholding can be slow, so if you want something
similar but faster, try <em>Triangle</em>. Always check that your
thresholding <em>looks right</em> afterwards.</p>
<p>Note that if all of the image is of interest, detrending is not
necessary and should not be done.</p>
</div>
<div class="section level3">
<h3 id="calculation-including-thresholding-and-detrending">Calculation including thresholding and detrending<a class="anchor" aria-label="anchor" href="#calculation-including-thresholding-and-detrending"></a>
</h3>
<p>To calculate the brightness of this image with <em>Huang</em>
thresholding and <em>Robin Hood</em> detrending, with the
<em>epsilon</em> definition of brightness, run</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_brightness_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness.html">brightness</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, </span>
<span>                                thresh <span class="op">=</span> <span class="st">"Huang"</span>, detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="timeseries-calculation">Timeseries calculation<a class="anchor" aria-label="anchor" href="#timeseries-calculation"></a>
</h4>
<p>To calculate a brightness timeseries with 50 frames per set, run</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_brightness_ts_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness_timeseries.html">brightness_timeseries</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, </span>
<span>                                              frames_per_set <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                              thresh <span class="op">=</span> <span class="st">"Huang"</span>, detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>To calculate an overlapped brightness timeseries with 50 frames per
set, run</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_brightness_ts_img_overlapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brightness_timeseries.html">brightness_timeseries</a></span><span class="op">(</span><span class="va">my_img</span>, def <span class="op">=</span> <span class="st">"e"</span>, </span>
<span>                                                         frames_per_set <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                                         overlap <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                                         thresh <span class="op">=</span> <span class="st">"Huang"</span>, </span>
<span>                                                         detrend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="saving-images">Saving Images<a class="anchor" aria-label="anchor" href="#saving-images"></a>
</h3>
<p>We can save the brightness images with <code>write_tif()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_img</span>, <span class="st">"desired/path/of/my-brightness-img"</span><span class="op">)</span></span>
<span><span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_ts_img</span>, <span class="st">"desired/path/of/my-brightness-ts-img"</span><span class="op">)</span></span>
<span><span class="fu">write_tif</span><span class="op">(</span><span class="va">my_brightness_ts_img_overlapped</span>, </span>
<span>          <span class="st">"desired/path/of/my-brightness-ts-img-overlapped"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="studying-the-distribution-of-brightnesses">Studying the Distribution of Brightnesses<a class="anchor" aria-label="anchor" href="#studying-the-distribution-of-brightnesses"></a>
</h3>
<p>We can take a look at the distribution of brightnesses in channel 1
of the brightness image:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">my_brightness_img</span><span class="op">[</span>, , <span class="fl">1</span>, <span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">db</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"brightness"</span>, y <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Channel 1 brightness distribution"</span><span class="op">)</span></span></code></pre></div>
<p><img src="single-images_files/figure-html/brightness%20density-1.png" width="672"></p>
<p>We can compare that to the distribution of brightnesses from immobile
particles:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">immobile_brightnesses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">50</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="fl">6</span>, <span class="fl">50</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">6</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="op">{</span><span class="fu">matrixStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowVars.html" class="external-link">rowVars</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">}</span></span>
<span><span class="va">di</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">immobile_brightnesses</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu">mutate</span><span class="op">(</span><span class="va">db</span>, mobility <span class="op">=</span> <span class="st">"mobile"</span><span class="op">)</span>, <span class="fu">mutate</span><span class="op">(</span><span class="va">di</span>, mobility <span class="op">=</span> <span class="st">"immobile"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mobility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mobility</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>colour <span class="op">=</span> <span class="va">mobility</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"brightness"</span>, y <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Channel 1 brightness distribution compared to immobile entities"</span><span class="op">)</span></span></code></pre></div>
<p><img src="single-images_files/figure-html/immobile%20plot-1.png" width="672"></p>
<p>Note that to create plots like these, you’ll need knowledge of the
<code>ggplot2</code> package.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rory Nolan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
