---
title: "Number and Brightness Image Analysis"
author: "Rory Nolan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Number and Brightness Image Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
set.seed(1)
```

### Loading the libraries

```{r load library, results='hide', message=FALSE}
required <- c("nandb", "tidyverse", "matrixStats")
sapply(required, library, character.only = TRUE)
```

### Reading and Displaying Images

Now let's read in an image:
```{r read image}
img <- read_tif(system.file("extdata", "50_big.tif", package = "nandb"))
dim(img)  # get img's dimensions
```
So we can see that `img` is a 3-dimensional array of $`r dim(img)[3]`$ slices each of which is a $`r dim(img)[1]` \times `r dim(img)[2]`$ image. We can view the mean projection of the stack:
```{r display image, fig.width=7, fig.height=7}
display(detrendr::mean_pillars(img))
```

### Preprocessing, Brightness Calculation and Post-Filtering

Now we can calculate the brightness image based on this image series, with an exponential filtering detrend with a time constant of (say) 10 frames and using the Huang thresholding method via 
```{r Brightness calculation with bleaching correction, fig.width=7, fig.height=7}
img_brightness <- brightness(img, "e", tau = "auto", thresh = "Huang")
display(img_brightness)
```

and we can see what happens when we median filter. 
```{r Brightness Plot, fig.width=7, fig.height=7}
img_brightness_med <- brightness(img, "e", tau = "auto", 
                                 thresh = "Huang", filt = "median")
display(img_brightness_med)
```

### Saving Text Images

We can save the brightness image (let's do it without median filtering this time). It saves as a text csv file (not as a tiff image, since the brightness values can be any non-negative real number, but tiff images can only store pixel values as integers).
```{r Brightness write to txt}
write_txt_img(img_brightness, "BrightnessImage")
list.files(pattern = "\\.txt$")  # check that the .txt file was written to the folder
```
```{r, echo=FALSE, results="hide"}
file.remove("BrightnessImage.txt")  # remove that file (clean up)
```

### Studying the Distribution of Brightnesses

We can take a look at the distribution of brightnesses in that image:
```{r brightness density, message=FALSE, fig.width=7, fig.height=7}
db <- density(img_brightness, na.rm = TRUE) %>% 
  {data.frame(x = .$x, y = .$y)}
ggplot(db, aes(x, y)) + geom_line() + 
  labs(x = "brightness", y = "frequency") +
  xlim(-2, 2)
```

and we can compare it to the distribution of brightnesses from immobile particles:
```{r immobile plot, fig.width=7, fig.height=7}
immobile_brightnesses <- matrix(rpois(50 * 10^6, 50), nrow = 10^6) %>% 
  {rowVars(.) / rowMeans(.) - 1}
di <- density(immobile_brightnesses) %>% {data.frame(x = .$x, y = .$y)}
rbind(mutate(db, mobility = "mobile"), mutate(di, mobility = "immobile")) %>%      mutate(mobility = factor(mobility)) %>% 
  ggplot(aes(x, y)) + geom_line(aes(colour = mobility)) + 
  labs(x = "brightness", y = "frequency") +
  xlim(-2, 2)
``` 
